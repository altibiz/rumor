#:schema ../../src/schema.json
[[imports]]
importer = "vault"
arguments.path = "secret/ssl"
arguments.allow_fail = true

[[exports]]
exporter = "vault"
arguments.path = "secret/ssl"

[[generations]]
generator = "text"
arguments.name = "openssl-ca-config"
arguments.text = """
[ req ]
distinguished_name = req_distinguished_name
prompt             = no
x509_extensions    = v3_ca

[ req_distinguished_name ]
CN = ca

[ v3_ca ]
subjectKeyIdentifier   = hash
authorityKeyIdentifier = keyid:always,issuer:always
basicConstraints       = critical, CA:true
keyUsage               = critical, digitalSignature, keyCertSign, cRLSign
"""

[[generations]]
generator = "openssl-ca"

[generations.arguments]
config = "openssl-ca-config"
public = "openssl-ca-pub"
private = "openssl-ca-priv"

[[generations]]
generator = "text"
arguments.name = "openssl-server-config"
arguments.text = """
[ req ]
distinguished_name = req_distinguished_name
prompt             = no
[ req_distinguished_name ]
CN = server-cert
[ ext ]
basicConstraints       = critical, CA:FALSE
nsComment              = "Server Certificate (Generated by My PKI)"
subjectKeyIdentifier   = hash
authorityKeyIdentifier = keyid:always,issuer:always
keyUsage               = critical, digitalSignature, keyEncipherment
extendedKeyUsage       = serverAuth
"""

[[generations]]
generator = "openssl"

[generations.arguments]
ca_public = "openssl-ca-pub"
ca_private = "openssl-ca-priv"
serial = "openssl-srl"
config = "openssl-server-config"
public = "openssl-server-pub"
private = "openssl-server-priv"
renew = true

[[generations]]
generator = "text"
arguments.name = "openssl-client-config"
arguments.text = """
[ req ]
distinguished_name = req_distinguished_name
prompt             = no
[ req_distinguished_name ]
CN = client-cert
[ ext ]
basicConstraints       = critical, CA:FALSE
nsComment              = "Client Certificate (Generated by My PKI)"
subjectKeyIdentifier   = hash
authorityKeyIdentifier = keyid:always,issuer:always
keyUsage               = critical, digitalSignature
extendedKeyUsage       = clientAuth
"""

[[generations]]
generator = "openssl"

[generations.arguments]
ca_public = "openssl-ca-pub"
ca_private = "openssl-ca-priv"
serial = "openssl-srl"
config = "openssl-client-config"
public = "openssl-client-pub"
private = "openssl-client-priv"
renew = true

[[generations]]
generator = "nebula-ca"

[generations.arguments]
name = "ca"
public = "nebula-ca-pub"
private = "nebula-ca-priv"

[[generations]]
generator = "nebula"

[generations.arguments]
ca_public = "nebula-ca-pub"
ca_private = "nebula-ca-priv"
name = "cert"
ip = "10.8.0.1/24"
public = "nebula-pub"
private = "nebula-priv"
renew = true

[[generations]]
generator = "age"

[generations.arguments]
public = "age.txt.pub"
private = "age.txt"

[[generations]]
generator = "sops"

[generations.arguments]
age = "age.txt.pub"
public = "sops.yaml.pub"
private = "sops.yaml"

[generations.arguments.secrets]
openssl-ca-pub = "openssl-ca-pub"
openssl-ca-priv = "openssl-ca-priv"
openssl-server-pub = "openssl-server-pub"
openssl-server-priv = "openssl-server-priv"
openssl-client-pub = "openssl-client-pub"
openssl-client-priv = "openssl-client-priv"
nebula-ca-pub = "nebula-ca-pub"
nebula-ca-priv = "nebula-ca-priv"
nebula-pub = "nebula-pub"
nebula-priv = "nebula-priv"
